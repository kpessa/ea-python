============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-8.3.5, pluggy-1.5.0
rootdir: /home/pessk/code/ea-python
plugins: sugar-1.0.0
collected 9 items

test_config_sentences.py FFF                                             [ 33%]
test_config_structure.py ..                                              [ 55%]
tests/test_dcw_sentences.py FF                                           [ 77%]
tests/test_expected_sentences.py FF                                      [100%]

=================================== FAILURES ===================================
______________________ test_all_expected_mnemonics_found _______________________

expected_sentences = defaultdict(<class 'set'>, {'BMP': {'Blood, ASAP (Now) collect, Once', 'Blood, Routine Today collect, Once', 'Blood, S... Once'}, 'sodium phosphate': {'15 mmol, IVPB, Inj, q4hr (interval), Duration: 2 dose(s)', '15 mmol, IVPB, Inj, Once'}})
actual_orders_by_mnemonic = defaultdict(<class 'set'>, {'magnesium sulfate': {'2 g, IVPB, Premix, q2hr (interval), Duration: 2 dose(s), Infuse ove..., IVPB, Inj, Once, Infuse over: 1 hr'}, 'magnesium oxide': {'400 mg, PO, Tab, q12hr (interval), Duration: 2 dose(s)'}})

    def test_all_expected_mnemonics_found(expected_sentences, actual_orders_by_mnemonic):
        """Check if all mnemonics defined in the domain extract are found in generated JSON."""
        missing_mnemonics = expected_sentences.keys() - actual_orders_by_mnemonic.keys()
>       assert not missing_mnemonics, \
            f"Mnemonics defined in {EXPECTED_EXTRACT_FILE} but not found in any generated JSON: {sorted(list(missing_mnemonics))}"
E       AssertionError: Mnemonics defined in /home/pessk/code/ea-python/expected_sentences/extract.csv but not found in any generated JSON: ['K-Phos Neutral']
E       assert not {'K-Phos Neutral'}

test_config_sentences.py:134: AssertionError
---------------------------- Captured stdout setup -----------------------------
(test_config_sentences) Loaded domain sentences for 15 mnemonics from /home/pessk/code/ea-python/expected_sentences/extract.csv
______________ test_no_unexpected_mnemonics_without_expectations _______________

expected_sentences = defaultdict(<class 'set'>, {'BMP': {'Blood, ASAP (Now) collect, Once', 'Blood, Routine Today collect, Once', 'Blood, S... Once'}, 'sodium phosphate': {'15 mmol, IVPB, Inj, q4hr (interval), Duration: 2 dose(s)', '15 mmol, IVPB, Inj, Once'}})
actual_orders_by_mnemonic = defaultdict(<class 'set'>, {'magnesium sulfate': {'2 g, IVPB, Premix, q2hr (interval), Duration: 2 dose(s), Infuse ove..., IVPB, Inj, Once, Infuse over: 1 hr'}, 'magnesium oxide': {'400 mg, PO, Tab, q12hr (interval), Duration: 2 dose(s)'}})

    def test_no_unexpected_mnemonics_without_expectations(expected_sentences, actual_orders_by_mnemonic):
        """Check if generated JSON contains mnemonics not present in the domain extract."""
        unexpected_mnemonics = actual_orders_by_mnemonic.keys() - expected_sentences.keys()
        # Filter out any mnemonics that might be intentionally generated but not have specific sentence expectations
        # (Requires a list of such allowed mnemonics if applicable)
        truly_unexpected = {m for m in unexpected_mnemonics if m} # Basic check for non-empty
>       assert not truly_unexpected, \
            f"Mnemonics found in generated JSON but NOT defined in {EXPECTED_EXTRACT_FILE}: {sorted(list(truly_unexpected))}"
E       AssertionError: Mnemonics found in generated JSON but NOT defined in /home/pessk/code/ea-python/expected_sentences/extract.csv: ['K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)']
E       assert not {'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)'}

test_config_sentences.py:143: AssertionError
__________________________ test_sentence_verification __________________________

expected_sentences = defaultdict(<class 'set'>, {'BMP': {'Blood, ASAP (Now) collect, Once', 'Blood, Routine Today collect, Once', 'Blood, S... Once'}, 'sodium phosphate': {'15 mmol, IVPB, Inj, q4hr (interval), Duration: 2 dose(s)', '15 mmol, IVPB, Inj, Once'}})
actual_orders_by_mnemonic = defaultdict(<class 'set'>, {'magnesium sulfate': {'2 g, IVPB, Premix, q2hr (interval), Duration: 2 dose(s), Infuse ove..., IVPB, Inj, Once, Infuse over: 1 hr'}, 'magnesium oxide': {'400 mg, PO, Tab, q12hr (interval), Duration: 2 dose(s)'}})

    def test_sentence_verification(expected_sentences, actual_orders_by_mnemonic):
        """Verify that generated sentences for each mnemonic exist in the expected extract.csv pool."""
        mnemonics_to_test = actual_orders_by_mnemonic.keys() # Test all generated mnemonics
    
        failures = [] # Store sentence mismatch errors
    
        for mnemonic in mnemonics_to_test:
            expected_set = expected_sentences.get(mnemonic, set()) # Sentences for this mnemonic in extract.csv
            found_set = actual_orders_by_mnemonic.get(mnemonic, set()) # Sentences generated in JSON
    
            # missing_expected = expected_set - found_set # Domain sentences not generated - IGNORE THIS CASE
            extra_generated = found_set - expected_set  # Generated sentences not in domain extract
    
            # Report generated sentences not matching the domain expectation for this mnemonic
            if extra_generated:
                error_detail = [f"Sentences generated for MNEMONIC '{mnemonic}' that DO NOT match any entry in {EXPECTED_EXTRACT_FILE}:"]
                for sentence in sorted(list(extra_generated)):
                    error_detail.append(f"    - {repr(sentence)}") # Use repr to show quotes clearly
                failures.append("\n".join(error_detail))
    
            # # Report domain sentences that were expected but not generated for this mnemonic - REMOVED
            # if missing_expected:
            #     error_detail = [f"Sentences defined for MNEMONIC '{mnemonic}' in {EXPECTED_EXTRACT_FILE} but NOT generated:"]
            #     for sentence in sorted(list(missing_expected)):
            #         error_detail.append(f"    - {sentence}")
            #     failures.append("\n".join(error_detail))
    
>       assert not failures, "\n\n" + "\n\n".join(failures)
E       AssertionError: 
E         
E         Sentences generated for MNEMONIC 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)' that DO NOT match any entry in /home/pessk/code/ea-python/expected_sentences/extract.csv:
E             - '2 tab(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'
E             - '2 tab(s), PO, Tab, q2hr (interval), Duration: 3 dose(s)'
E       assert not ["Sentences generated for MNEMONIC 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosph...b(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'\n    - '2 tab(s), PO, Tab, q2hr (interval), Duration: 3 dose(s)'"]

test_config_sentences.py:173: AssertionError
_ test_dcw_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_cardiac.json] _

config_file_path = '/home/pessk/code/ea-python/generated_configs/output_cardiac.json'
dcw_data = [{'Electrolyte': 'Magnesium', 'Instructions/Note': 'Recheck BMP and magnesium level with next AM labs.', 'Lab Value Ra... Range': 'Current serum level 3.2-3.4', 'Mnemonic': 'potassium chloride 10 mEq/100 mL intravenous solution', ...}, ...]

    @pytest.mark.parametrize("config_file_path", get_generated_config_paths())
    def test_dcw_sentences_match_generated(config_file_path, dcw_data):
        """
        Compares sentences from DCW against generated JSON using fuzzy matching.
        Generates a report showing the comparison and score for each DCW entry.
        """
        try:
            with open(config_file_path, 'r', encoding='utf-8') as f:
                loaded_json_config = json.load(f)
        except Exception as e:
            pytest.fail(f"Failed to load or parse JSON from {config_file_path}: {e}")
    
        protocol = get_protocol_from_filename(config_file_path)
        assert protocol, f"Could not determine protocol from filename: {config_file_path}"
    
        protocol_dcw_entries = [e for e in dcw_data if e.get('Protocol') == protocol]
        if not protocol_dcw_entries:
            print(f"Warning: No DCW entries found for protocol: {protocol}. Skipping verification.")
            return
    
        comparison_report_lines = []
        processing_errors = []
    
        for index, dcw_entry in enumerate(protocol_dcw_entries):
            dcw_electrolyte = dcw_entry.get('Electrolyte')
            dcw_mnemonic = dcw_entry.get('Mnemonic')
            dcw_range = dcw_entry.get('Lab Value Range') # Keep for context
            dcw_sentence = dcw_entry.get('Order_Sentence')
    
            if not all([protocol, dcw_electrolyte, dcw_mnemonic, dcw_sentence]):
                continue
    
            # --- Find JSON Counterpart (by mnemonic within the correct tab) ---
            json_sentence_found = None
            try:
                tabs = loaded_json_config.get('RCONFIG', {}).get('TABS', [])
                target_tab = next((
                    t for t in tabs
                    if t.get('TAB_KEY') and dcw_electrolyte and (
                        # Standard check
                        (t.get('TAB_KEY').upper() == dcw_electrolyte.upper()) or
                        # Specific mapping for Phosphorus -> PHOSPHATE
                        (dcw_electrolyte.upper() == 'PHOSPHORUS' and t.get('TAB_KEY').upper() == 'PHOSPHATE')
                       )
                ), None)
    
                if target_tab:
                    order_sections = target_tab.get('ORDER_SECTIONS', [])
                    for section in order_sections:
                        orders_in_section = section.get('ORDERS', [])
                        for order in orders_in_section:
                            if order.get('MNEMONIC') == dcw_mnemonic:
                                json_sentence_found = order.get('ORDER_SENTENCE')
                                if json_sentence_found: # Found the first match
                                    break
                        if json_sentence_found:
                            break
    
            except Exception as e:
                processing_errors.append(f"Error finding JSON counterpart for DCW entry {index}: {e}")
                continue
    
            # --- Fuzzy Compare DCW vs JSON ---
            comparison_score = 0
            if json_sentence_found:
                comparison_score = fuzz.token_sort_ratio(dcw_sentence, json_sentence_found)
            # else: json_sentence_found remains None
    
            # --- Compile Report Line ---
            report_line = f'''
    --- DCW Entry #{index} (Mnem: '{dcw_mnemonic}', Range: '{dcw_range}') ---
      DCW Spec : {repr(dcw_sentence)}
      JSON Gen : {repr(json_sentence_found) if json_sentence_found else '*** NOT FOUND in JSON Tab ***'}
      (Score DCW vs JSON: {comparison_score}%)'''
            comparison_report_lines.append(report_line)
    
        # --- Final Assertion ---
        final_output_message = ""
        if comparison_report_lines:
            final_output_message += f"\nDCW vs JSON Sentence Comparison Report for {os.path.basename(config_file_path)}:\n"
            final_output_message += "\n".join(comparison_report_lines)
        if processing_errors:
             final_output_message += f"\n\nErrors encountered during processing for {os.path.basename(config_file_path)}:\n"
             final_output_message += "\n".join(processing_errors)
    
        # Fail if there's anything in the report to ensure it's always printed
>       assert not final_output_message, final_output_message
E       AssertionError: 
E         DCW vs JSON Sentence Comparison Report for output_cardiac.json:
E         
E         --- DCW Entry #0 (Mnem: 'magnesium sulfate', Range: 'Current serum level 1.8-2') ---
E           DCW Spec : '1 g, IVPB, Premix, Once, infuse over  1 hr'
E           JSON Gen : '1 g, IVPB, Premix, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #1 (Mnem: 'magnesium sulfate', Range: 'Current serum level 1.4-1.7') ---
E           DCW Spec : '2 g, IVPB, Premix, Once, infuse over 2 hr'
E           JSON Gen : '1 g, IVPB, Premix, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 95%)
E         
E         --- DCW Entry #2 (Mnem: 'magnesium sulfate', Range: 'Current serum level < 1.4') ---
E           DCW Spec : '2 g, IVPB, Premix, q2h interval, Duration: 2 doses, infuse over 2 hr'
E           JSON Gen : '1 g, IVPB, Premix, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 61%)
E         
E         --- DCW Entry #3 (Mnem: 'potassium chloride extended release', Range: 'Current serum level 3.6-3.9') ---
E           DCW Spec : '20 mEq, PO, ER tab, Once'
E           JSON Gen : '20 mEq, PO, ER tab, Once'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #4 (Mnem: 'potassium chloride', Range: 'Current serum level 3.6-3.9') ---
E           DCW Spec : '20 mEq, Feeding Tube, liq, Once'
E           JSON Gen : '20 mEq, Feeding Tube, Liq, Once'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #5 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level 3.6-3.9') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 2 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 2 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 96%)
E         
E         --- DCW Entry #6 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level 3.6-3.9') ---
E           DCW Spec : '20 mEq, IV, q1hr, Once, infuse over 1 hr'
E           JSON Gen : '20 mEq, IV, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 93%)
E         
E         --- DCW Entry #7 (Mnem: 'potassium chloride extended release', Range: 'Current serum level 3.2-3.5') ---
E           DCW Spec : '20 mEq, PO, ER tab, q2h interval, Duration: 2 doses'
E           JSON Gen : '20 mEq, PO, ER tab, Once'
E           (Score DCW vs JSON: 51%)
E         
E         --- DCW Entry #8 (Mnem: 'potassium chloride', Range: 'Current serum level 3.2-3.5') ---
E           DCW Spec : '20 mEq, Feeding Tube, liq, q2h interval, Duration: 2 doses'
E           JSON Gen : '20 mEq, Feeding Tube, Liq, Once'
E           (Score DCW vs JSON: 59%)
E         
E         --- DCW Entry #9 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level 3.2-3.5') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 4 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 2 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 94%)
E         
E         --- DCW Entry #10 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level 3.2-3.5') ---
E           DCW Spec : '20 mEq, IV, q1h, Duration: 2 doses, infuse over 1 hr'
E           JSON Gen : '20 mEq, IV, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 67%)
E         
E         --- DCW Entry #11 (Mnem: 'potassium chloride extended release', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, PO, ER tab, q2h interval, Duration: 3 doses'
E           JSON Gen : '20 mEq, PO, ER tab, Once'
E           (Score DCW vs JSON: 51%)
E         
E         --- DCW Entry #12 (Mnem: 'potassium chloride', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, Feeding Tube, liq, q2h interval, Duration: 3 doses'
E           JSON Gen : '20 mEq, Feeding Tube, Liq, Once'
E           (Score DCW vs JSON: 59%)
E         
E         --- DCW Entry #13 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 6 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 2 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 94%)
E         
E         --- DCW Entry #14 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, IV, q1h, Duration: 3 doses, infuse over 1 hr'
E           JSON Gen : '20 mEq, IV, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 67%)
E         
E         --- DCW Entry #15 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level < 2.8') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 8 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 2 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 94%)
E         
E         --- DCW Entry #16 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level < 2.8') ---
E           DCW Spec : '20 mEq, IV, q1h, Duration: 4 doses, infuse over 1 hr'
E           JSON Gen : '20 mEq, IV, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 67%)
E         
E         --- DCW Entry #17 (Mnem: 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Range: 'Current serum level 1.6-2.0') ---
E           DCW Spec : '2 tabs, q2h interval, PO, tab, Duration: 2 doses'
E           JSON Gen : '2 tab(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 92%)
E         
E         --- DCW Entry #18 (Mnem: 'sodium phosphate', Range: 'Current serum level 1.6-2.0') ---
E           DCW Spec : '15 mmol, IVPB, inj, Once'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #19 (Mnem: 'K-Phos Neutral', Range: 'Current serum level 1.0-1.5') ---
E           DCW Spec : '2 tabs, q2h interval, PO, tab, Duration: 3 doses'
E           JSON Gen : *** NOT FOUND in JSON Tab ***
E           (Score DCW vs JSON: 0%)
E         
E         --- DCW Entry #20 (Mnem: 'sodium phosphate', Range: 'Current serum level 1.0-1.5') ---
E           DCW Spec : '15 mmol, IVPB, inj, q4h interval, Duration: 2 dose'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 52%)
E         
E         --- DCW Entry #21 (Mnem: 'sodium phosphate', Range: 'Current serum level <1.0') ---
E           DCW Spec : '15 mmol, IVPB, inj, q4h interval, Duration: 2 dose'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 52%)
E         
E         --- DCW Entry #22 (Mnem: 'calcium chloride', Range: 'iCal < 1.1') ---
E           DCW Spec : '1 g, IVPB, Inj, Once, Infuse over: 1 hr'
E           JSON Gen : '1 g, IVPB, Inj, Once, Infuse over: 1 hr'
E           (Score DCW vs JSON: 100%)
E       assert not "\nDCW vs JSON Sentence Comparison Report for output_cardiac.json:\n\n--- DCW Entry #0 (Mnem: 'magnesium sulfate', Ran...PB, Inj, Once, Infuse over: 1 hr'\n  JSON Gen : '1 g, IVPB, Inj, Once, Infuse over: 1 hr'\n  (Score DCW vs JSON: 100%)"

tests/test_dcw_sentences.py:244: AssertionError
_ test_dcw_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_regular.json] _

config_file_path = '/home/pessk/code/ea-python/generated_configs/output_regular.json'
dcw_data = [{'Electrolyte': 'Magnesium', 'Instructions/Note': 'Recheck BMP and magnesium level with next AM labs.', 'Lab Value Ra... Range': 'Current serum level 3.2-3.4', 'Mnemonic': 'potassium chloride 10 mEq/100 mL intravenous solution', ...}, ...]

    @pytest.mark.parametrize("config_file_path", get_generated_config_paths())
    def test_dcw_sentences_match_generated(config_file_path, dcw_data):
        """
        Compares sentences from DCW against generated JSON using fuzzy matching.
        Generates a report showing the comparison and score for each DCW entry.
        """
        try:
            with open(config_file_path, 'r', encoding='utf-8') as f:
                loaded_json_config = json.load(f)
        except Exception as e:
            pytest.fail(f"Failed to load or parse JSON from {config_file_path}: {e}")
    
        protocol = get_protocol_from_filename(config_file_path)
        assert protocol, f"Could not determine protocol from filename: {config_file_path}"
    
        protocol_dcw_entries = [e for e in dcw_data if e.get('Protocol') == protocol]
        if not protocol_dcw_entries:
            print(f"Warning: No DCW entries found for protocol: {protocol}. Skipping verification.")
            return
    
        comparison_report_lines = []
        processing_errors = []
    
        for index, dcw_entry in enumerate(protocol_dcw_entries):
            dcw_electrolyte = dcw_entry.get('Electrolyte')
            dcw_mnemonic = dcw_entry.get('Mnemonic')
            dcw_range = dcw_entry.get('Lab Value Range') # Keep for context
            dcw_sentence = dcw_entry.get('Order_Sentence')
    
            if not all([protocol, dcw_electrolyte, dcw_mnemonic, dcw_sentence]):
                continue
    
            # --- Find JSON Counterpart (by mnemonic within the correct tab) ---
            json_sentence_found = None
            try:
                tabs = loaded_json_config.get('RCONFIG', {}).get('TABS', [])
                target_tab = next((
                    t for t in tabs
                    if t.get('TAB_KEY') and dcw_electrolyte and (
                        # Standard check
                        (t.get('TAB_KEY').upper() == dcw_electrolyte.upper()) or
                        # Specific mapping for Phosphorus -> PHOSPHATE
                        (dcw_electrolyte.upper() == 'PHOSPHORUS' and t.get('TAB_KEY').upper() == 'PHOSPHATE')
                       )
                ), None)
    
                if target_tab:
                    order_sections = target_tab.get('ORDER_SECTIONS', [])
                    for section in order_sections:
                        orders_in_section = section.get('ORDERS', [])
                        for order in orders_in_section:
                            if order.get('MNEMONIC') == dcw_mnemonic:
                                json_sentence_found = order.get('ORDER_SENTENCE')
                                if json_sentence_found: # Found the first match
                                    break
                        if json_sentence_found:
                            break
    
            except Exception as e:
                processing_errors.append(f"Error finding JSON counterpart for DCW entry {index}: {e}")
                continue
    
            # --- Fuzzy Compare DCW vs JSON ---
            comparison_score = 0
            if json_sentence_found:
                comparison_score = fuzz.token_sort_ratio(dcw_sentence, json_sentence_found)
            # else: json_sentence_found remains None
    
            # --- Compile Report Line ---
            report_line = f'''
    --- DCW Entry #{index} (Mnem: '{dcw_mnemonic}', Range: '{dcw_range}') ---
      DCW Spec : {repr(dcw_sentence)}
      JSON Gen : {repr(json_sentence_found) if json_sentence_found else '*** NOT FOUND in JSON Tab ***'}
      (Score DCW vs JSON: {comparison_score}%)'''
            comparison_report_lines.append(report_line)
    
        # --- Final Assertion ---
        final_output_message = ""
        if comparison_report_lines:
            final_output_message += f"\nDCW vs JSON Sentence Comparison Report for {os.path.basename(config_file_path)}:\n"
            final_output_message += "\n".join(comparison_report_lines)
        if processing_errors:
             final_output_message += f"\n\nErrors encountered during processing for {os.path.basename(config_file_path)}:\n"
             final_output_message += "\n".join(processing_errors)
    
        # Fail if there's anything in the report to ensure it's always printed
>       assert not final_output_message, final_output_message
E       AssertionError: 
E         DCW vs JSON Sentence Comparison Report for output_regular.json:
E         
E         --- DCW Entry #0 (Mnem: 'magnesium oxide', Range: 'Current serum level 1.4-1.5') ---
E           DCW Spec : '400 mg, PO, tab,  q12h interval, Duration: 2 doses'
E           JSON Gen : '400 mg, PO, Tab, q12hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 96%)
E         
E         --- DCW Entry #1 (Mnem: 'magnesium sulfate', Range: 'Current serum level 1.4-1.5') ---
E           DCW Spec : '2 g, IVPB, Premix, Once, infuse over 2 hr'
E           JSON Gen : '2 g, IVPB, Premix, Once, Infuse over: 2 hr'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #2 (Mnem: 'magnesium sulfate', Range: 'Current serum level < 1.4') ---
E           DCW Spec : '2 g, IVPB, Premix, q2h interval, Duration: 2 doses, infuse over 2 hr'
E           JSON Gen : '2 g, IVPB, Premix, Once, Infuse over: 2 hr'
E           (Score DCW vs JSON: 65%)
E         
E         --- DCW Entry #3 (Mnem: 'potassium chloride extended release', Range: 'Current serum level 3.2-3.4') ---
E           DCW Spec : '20 mEq, PO, ER tab, q2h interval, Duration: 2 doses'
E           JSON Gen : '20 mEq, PO, ER tab, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 96%)
E         
E         --- DCW Entry #4 (Mnem: 'potassium chloride', Range: 'Current serum level 3.2-3.4') ---
E           DCW Spec : '20 mEq, Feeding Tube, liq, q2h interval, Duration: 2 doses'
E           JSON Gen : '20 mEq, Feeding Tube, Liq, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 96%)
E         
E         --- DCW Entry #5 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level 3.2-3.4') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 4 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 4 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 96%)
E         
E         --- DCW Entry #6 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level 3.2-3.4') ---
E           DCW Spec : '20 mEq, IV, q2h interval, Duration: 2 doses, infuse over 2 hr'
E           JSON Gen : '20 mEq, IV, q2hr, Duration: 2 dose(s), Infuse over: 2 hr'
E           (Score DCW vs JSON: 88%)
E         
E         --- DCW Entry #7 (Mnem: 'potassium chloride extended release', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, PO, ER tab, q2h interval, Duration: 3 doses'
E           JSON Gen : '20 mEq, PO, ER tab, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 91%)
E         
E         --- DCW Entry #8 (Mnem: 'potassium chloride', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, Feeding Tube, liq, q2h interval, Duration: 3 doses'
E           JSON Gen : '20 mEq, Feeding Tube, Liq, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 93%)
E         
E         --- DCW Entry #9 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 6 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 4 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 94%)
E         
E         --- DCW Entry #10 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level 2.8-3.1') ---
E           DCW Spec : '20 mEq, IV, q2h interval, Duration: 3 doses, infuse over 2 hr'
E           JSON Gen : '20 mEq, IV, q2hr, Duration: 2 dose(s), Infuse over: 2 hr'
E           (Score DCW vs JSON: 84%)
E         
E         --- DCW Entry #11 (Mnem: 'potassium chloride 10 mEq/100 mL intravenous solution', Range: 'Current serum level < 2.8') ---
E           DCW Spec : '10 mEq, IV, q1h, Duration: 8 doses, infuse over 1 hr'
E           JSON Gen : '10 mEq, IV, q1hr, Duration: 4 dose(s), Infuse over: 1 hr'
E           (Score DCW vs JSON: 94%)
E         
E         --- DCW Entry #12 (Mnem: 'potassium chloride 20 mEq/100 mL intravenous solution', Range: 'Current serum level < 2.8') ---
E           DCW Spec : '20 mEq, IV, q2h interval, Duration: 4 doses, infuse over 2 hr'
E           JSON Gen : '20 mEq, IV, q2hr, Duration: 2 dose(s), Infuse over: 2 hr'
E           (Score DCW vs JSON: 84%)
E         
E         --- DCW Entry #13 (Mnem: 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Range: 'Current serum level 1.6-2.0') ---
E           DCW Spec : '2 tabs, q2h interval, PO, tab, Duration: 2 doses'
E           JSON Gen : '2 tab(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'
E           (Score DCW vs JSON: 92%)
E         
E         --- DCW Entry #14 (Mnem: 'sodium phosphate', Range: 'Current serum level 1.6-2.0') ---
E           DCW Spec : '15 mmol, IVPB, inj, Once'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 100%)
E         
E         --- DCW Entry #15 (Mnem: 'K-Phos Neutral', Range: 'Current serum level 1.0-1.5') ---
E           DCW Spec : '2 tabs, q2h interval, PO, tab, Duration: 3 doses'
E           JSON Gen : *** NOT FOUND in JSON Tab ***
E           (Score DCW vs JSON: 0%)
E         
E         --- DCW Entry #16 (Mnem: 'sodium phosphate', Range: 'Current serum level 1.0-1.5') ---
E           DCW Spec : '15 mmol, IVPB, inj, q4h interval, Duration: 2 dose'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 52%)
E         
E         --- DCW Entry #17 (Mnem: 'sodium phosphate', Range: 'Current serum level <1.0') ---
E           DCW Spec : '15 mmol, IVPB, inj, q4h interval, Duration: 2 dose'
E           JSON Gen : '15 mmol, IVPB, Inj, Once'
E           (Score DCW vs JSON: 52%)
E       assert not "\nDCW vs JSON Sentence Comparison Report for output_regular.json:\n\n--- DCW Entry #0 (Mnem: 'magnesium oxide', Range... mmol, IVPB, inj, q4h interval, Duration: 2 dose'\n  JSON Gen : '15 mmol, IVPB, Inj, Once'\n  (Score DCW vs JSON: 52%)"

tests/test_dcw_sentences.py:244: AssertionError
_ test_expected_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_cardiac.json] _

config_file_path = '/home/pessk/code/ea-python/generated_configs/output_cardiac.json'

    @pytest.mark.parametrize("config_file_path", get_generated_config_paths())
    def test_expected_sentences_match_generated(config_file_path):
        """
        Verifies that order sentences in the generated JSON match EXACTLY those defined
        in the individual files within expected_sentences/.
        """
        # --- Clear cache before each test run ---
        load_expected_sentences.cache_clear()
        # --- End Clear Cache ---
    
        # Load JSON inside the test now
        try:
            with open(config_file_path, 'r', encoding='utf-8') as f:
                loaded_json_config = json.load(f)
        except Exception as e:
            pytest.fail(f"Failed to load or parse JSON from {config_file_path}: {e}")
    
        protocol = get_protocol_from_filename(config_file_path)
        assert protocol, f"Could not determine protocol from filename: {config_file_path}"
    
        errors = []
        processed_json_orders = set()
        # No longer need unmatched_domain_sentences tracking based on extract.csv
    
        # Iterate through the generated JSON structure first
        try:
            tabs = loaded_json_config.get('RCONFIG', {}).get('TABS', [])
            for tab in tabs:
                tab_key = tab.get('TAB_KEY')
                if not tab_key:
                    continue
    
                order_sections = tab.get('ORDER_SECTIONS', [])
                for section_index, section in enumerate(order_sections):
                    orders_in_section = section.get('ORDERS', [])
                    for order_index, order in enumerate(orders_in_section):
                        json_mnemonic = order.get('MNEMONIC')
                        json_sentence = order.get('ORDER_SENTENCE')
                        json_order_id = f"{tab_key}-S{section_index}-O{order_index}-{json_mnemonic}"
    
                        if not json_mnemonic or not json_sentence:
                            continue
                        if json_order_id in processed_json_orders:
                            continue
    
                        # --- Debug: Print mnemonic being loaded ---
                        print(f"DEBUG: Loading expected for Mnemonic='{json_mnemonic}', Tab='{tab_key}'")
                        # --- End Debug ---
    
                        # Load expected sentences from individual file for this mnemonic
                        expected_sentences = load_expected_sentences(json_mnemonic, tab_key)
    
                        if not expected_sentences:
                            # Mnemonic in JSON does not have a corresponding expected file or file is empty!
                            errors.append(
                                f"  - Unexpected/Missing File: Mnemonic '{json_mnemonic}' in Tab '{tab_key}'\n"
                                f"    JSON Sentence: {repr(json_sentence)}\n"
                                f"    (No corresponding file found or file empty in expected_sentences/)"
                            )
                            processed_json_orders.add(json_order_id)
                            continue
    
                        # --- Exact Comparison Logic ---
                        if json_sentence in expected_sentences:
                            # Exact match found - good!
                            processed_json_orders.add(json_order_id)
                        else:
                            # Exact match NOT found - this is an error
                            # Format expected sentences for error message
                            expected_list_str = "\n      Expected Sentences in File:\n"
                            preview_count = 3
                            expected_list_str += "\n".join([f"        - {repr(s)}" for s in list(expected_sentences)[:preview_count]])
                            if len(expected_sentences) > preview_count:
                                expected_list_str += f"\n        - ... ({len(expected_sentences) - preview_count} more)"
    
                            errors.append(
                                f"  - Sentence Mismatch: Mnemonic '{json_mnemonic}' in Tab '{tab_key}'\n"
                                f"    JSON    : {repr(json_sentence)}\n"
                                f"    Expected: Not found exactly in its expected file.{expected_list_str}"
                            )
                            processed_json_orders.add(json_order_id)
    
        except Exception as e:
            pytest.fail(f"Error processing JSON structure in {config_file_path}: {e}")
    
        # --- Final Assertion ---
        if errors:
            final_error_message = f"\nFound Discrepancies (JSON vs Expected Files) in {os.path.basename(config_file_path)}:\n"
            final_error_message += "\n".join(errors)
>           assert not final_error_message, final_error_message
E           AssertionError: 
E             Found Discrepancies (JSON vs Expected Files) in output_cardiac.json:
E               - Unexpected/Missing File: Mnemonic 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)' in Tab 'PHOSPHATE'
E                 JSON Sentence: '2 tab(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'
E                 (No corresponding file found or file empty in expected_sentences/)
E               - Unexpected/Missing File: Mnemonic 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)' in Tab 'PHOSPHATE'
E                 JSON Sentence: '2 tab(s), PO, Tab, q2hr (interval), Duration: 3 dose(s)'
E                 (No corresponding file found or file empty in expected_sentences/)
E           assert not "\nFound Discrepancies (JSON vs Expected Files) in output_cardiac.json:\n  - Unexpected/Missing File: Mnemonic 'K-Phos...PO, Tab, q2hr (interval), Duration: 3 dose(s)'\n    (No corresponding file found or file empty in expected_sentences/)"

tests/test_expected_sentences.py:200: AssertionError
----------------------------- Captured stdout call -----------------------------
DEBUG: Loading expected for Mnemonic='magnesium sulfate', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='magnesium sulfate', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='magnesium sulfate', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride extended release', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride extended release', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride extended release', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Tab='PHOSPHATE'
DEBUG (test_expected_sentences): Expected file path check failed (os.path.isfile) for: /home/pessk/code/ea-python/expected_sentences/meds/phosphate/K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate).csv
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='calcium chloride', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='CALCIUM'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='CALCIUM'
_ test_expected_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_regular.json] _

config_file_path = '/home/pessk/code/ea-python/generated_configs/output_regular.json'

    @pytest.mark.parametrize("config_file_path", get_generated_config_paths())
    def test_expected_sentences_match_generated(config_file_path):
        """
        Verifies that order sentences in the generated JSON match EXACTLY those defined
        in the individual files within expected_sentences/.
        """
        # --- Clear cache before each test run ---
        load_expected_sentences.cache_clear()
        # --- End Clear Cache ---
    
        # Load JSON inside the test now
        try:
            with open(config_file_path, 'r', encoding='utf-8') as f:
                loaded_json_config = json.load(f)
        except Exception as e:
            pytest.fail(f"Failed to load or parse JSON from {config_file_path}: {e}")
    
        protocol = get_protocol_from_filename(config_file_path)
        assert protocol, f"Could not determine protocol from filename: {config_file_path}"
    
        errors = []
        processed_json_orders = set()
        # No longer need unmatched_domain_sentences tracking based on extract.csv
    
        # Iterate through the generated JSON structure first
        try:
            tabs = loaded_json_config.get('RCONFIG', {}).get('TABS', [])
            for tab in tabs:
                tab_key = tab.get('TAB_KEY')
                if not tab_key:
                    continue
    
                order_sections = tab.get('ORDER_SECTIONS', [])
                for section_index, section in enumerate(order_sections):
                    orders_in_section = section.get('ORDERS', [])
                    for order_index, order in enumerate(orders_in_section):
                        json_mnemonic = order.get('MNEMONIC')
                        json_sentence = order.get('ORDER_SENTENCE')
                        json_order_id = f"{tab_key}-S{section_index}-O{order_index}-{json_mnemonic}"
    
                        if not json_mnemonic or not json_sentence:
                            continue
                        if json_order_id in processed_json_orders:
                            continue
    
                        # --- Debug: Print mnemonic being loaded ---
                        print(f"DEBUG: Loading expected for Mnemonic='{json_mnemonic}', Tab='{tab_key}'")
                        # --- End Debug ---
    
                        # Load expected sentences from individual file for this mnemonic
                        expected_sentences = load_expected_sentences(json_mnemonic, tab_key)
    
                        if not expected_sentences:
                            # Mnemonic in JSON does not have a corresponding expected file or file is empty!
                            errors.append(
                                f"  - Unexpected/Missing File: Mnemonic '{json_mnemonic}' in Tab '{tab_key}'\n"
                                f"    JSON Sentence: {repr(json_sentence)}\n"
                                f"    (No corresponding file found or file empty in expected_sentences/)"
                            )
                            processed_json_orders.add(json_order_id)
                            continue
    
                        # --- Exact Comparison Logic ---
                        if json_sentence in expected_sentences:
                            # Exact match found - good!
                            processed_json_orders.add(json_order_id)
                        else:
                            # Exact match NOT found - this is an error
                            # Format expected sentences for error message
                            expected_list_str = "\n      Expected Sentences in File:\n"
                            preview_count = 3
                            expected_list_str += "\n".join([f"        - {repr(s)}" for s in list(expected_sentences)[:preview_count]])
                            if len(expected_sentences) > preview_count:
                                expected_list_str += f"\n        - ... ({len(expected_sentences) - preview_count} more)"
    
                            errors.append(
                                f"  - Sentence Mismatch: Mnemonic '{json_mnemonic}' in Tab '{tab_key}'\n"
                                f"    JSON    : {repr(json_sentence)}\n"
                                f"    Expected: Not found exactly in its expected file.{expected_list_str}"
                            )
                            processed_json_orders.add(json_order_id)
    
        except Exception as e:
            pytest.fail(f"Error processing JSON structure in {config_file_path}: {e}")
    
        # --- Final Assertion ---
        if errors:
            final_error_message = f"\nFound Discrepancies (JSON vs Expected Files) in {os.path.basename(config_file_path)}:\n"
            final_error_message += "\n".join(errors)
>           assert not final_error_message, final_error_message
E           AssertionError: 
E             Found Discrepancies (JSON vs Expected Files) in output_regular.json:
E               - Unexpected/Missing File: Mnemonic 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)' in Tab 'PHOSPHATE'
E                 JSON Sentence: '2 tab(s), PO, Tab, q2hr (interval), Duration: 2 dose(s)'
E                 (No corresponding file found or file empty in expected_sentences/)
E               - Unexpected/Missing File: Mnemonic 'K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)' in Tab 'PHOSPHATE'
E                 JSON Sentence: '2 tab(s), PO, Tab, q2hr (interval), Duration: 3 dose(s)'
E                 (No corresponding file found or file empty in expected_sentences/)
E           assert not "\nFound Discrepancies (JSON vs Expected Files) in output_regular.json:\n  - Unexpected/Missing File: Mnemonic 'K-Phos...PO, Tab, q2hr (interval), Duration: 3 dose(s)'\n    (No corresponding file found or file empty in expected_sentences/)"

tests/test_expected_sentences.py:200: AssertionError
----------------------------- Captured stdout call -----------------------------
DEBUG: Loading expected for Mnemonic='magnesium oxide', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='magnesium sulfate', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='magnesium sulfate', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='MAGNESIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride extended release', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride extended release', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 10 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='potassium chloride 20 mEq/100 mL intravenous solution', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Potassium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='BMP', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Magnesium Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='POTASSIUM'
DEBUG: Loading expected for Mnemonic='K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Tab='PHOSPHATE'
DEBUG (test_expected_sentences): Expected file path check failed (os.path.isfile) for: /home/pessk/code/ea-python/expected_sentences/meds/phosphate/K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate).csv
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='K-Phos Neutral (brand name synonym under primary potassium phosphate-sodium phosphate)', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='sodium phosphate', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Phosphate Level', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Serum', Tab='PHOSPHATE'
DEBUG: Loading expected for Mnemonic='Calcium Level Ionized, Whole Blood', Tab='PHOSPHATE'
=========================== short test summary info ============================
FAILED test_config_sentences.py::test_all_expected_mnemonics_found - Assertio...
FAILED test_config_sentences.py::test_no_unexpected_mnemonics_without_expectations
FAILED test_config_sentences.py::test_sentence_verification - AssertionError: 
FAILED tests/test_dcw_sentences.py::test_dcw_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_cardiac.json]
FAILED tests/test_dcw_sentences.py::test_dcw_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_regular.json]
FAILED tests/test_expected_sentences.py::test_expected_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_cardiac.json]
FAILED tests/test_expected_sentences.py::test_expected_sentences_match_generated[/home/pessk/code/ea-python/generated_configs/output_regular.json]
========================= 7 failed, 2 passed in 0.32s ==========================
